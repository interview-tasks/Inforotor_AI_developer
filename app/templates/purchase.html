{% extends "base.html" %}

{% block title %}Purchase Prediction - POS ML Platform{% endblock %}

{% block content %}
<div class="container">
    <section class="hero">
        <h1>üí∞ Purchase Value Prediction</h1>
        <p class="subtitle">Forecast customer purchase value for optimized upselling</p>
    </section>

    <div class="form-section">
        <h2>Enter Customer & Context Data</h2>
        <form id="purchaseForm">
            <div class="form-group">
                <label for="customer_age">Customer Age</label>
                <input type="number" id="customer_age" name="customer_age"
                       min="18" max="100" required value="35">
            </div>

            <div class="form-group">
                <label for="customer_gender">Customer Gender</label>
                <select id="customer_gender" name="customer_gender" required>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                </select>
            </div>

            <div class="form-group">
                <label for="hour">Hour of Day (0-23)</label>
                <input type="number" id="hour" name="hour"
                       min="0" max="23" required value="14">
                <small>Hour in 24-hour format</small>
            </div>

            <div class="form-group">
                <label for="day_of_week">Day of Week</label>
                <select id="day_of_week" name="day_of_week" required>
                    <option value="0">Monday</option>
                    <option value="1">Tuesday</option>
                    <option value="2">Wednesday</option>
                    <option value="3">Thursday</option>
                    <option value="4">Friday</option>
                    <option value="5" selected>Saturday</option>
                    <option value="6">Sunday</option>
                </select>
            </div>

            <div class="form-group">
                <label for="temperature_c">Temperature (¬∞C)</label>
                <input type="number" id="temperature_c" name="temperature_c"
                       step="0.1" min="-20" max="50" required value="22.5">
            </div>

            <div class="form-group">
                <label for="is_rainy">Weather Condition</label>
                <select id="is_rainy" name="is_rainy" required>
                    <option value="false" selected>Clear/Sunny</option>
                    <option value="true">Rainy</option>
                </select>
            </div>

            <div class="form-group">
                <label for="visit_duration_minutes">Expected Visit Duration (minutes)</label>
                <input type="number" id="visit_duration_minutes" name="visit_duration_minutes"
                       min="5" max="180" required value="60">
            </div>

            <button type="submit" class="btn btn-primary">Predict Purchase Value</button>
        </form>
    </div>

    <div id="loading" class="loading" style="display: none;">
        <div class="spinner"></div>
        <p>Calculating purchase prediction...</p>
    </div>

    <div id="result" style="display: none;"></div>

    <section class="benefits-section">
        <h2>How It Works</h2>
        <div class="benefits-grid">
            <div class="benefit-item">
                <h4>üìä XGBoost Algorithm</h4>
                <p>State-of-the-art gradient boosting model trained on 10,000+ transactions with real behavioral patterns.</p>
            </div>
            <div class="benefit-item">
                <h4>üéØ Multi-Factor Analysis</h4>
                <p>Considers demographics, temporal patterns, weather conditions, and visit duration for accurate predictions.</p>
            </div>
            <div class="benefit-item">
                <h4>üí° Actionable Insights</h4>
                <p>Provides tier classification and specific upselling recommendations to maximize revenue.</p>
            </div>
            <div class="benefit-item">
                <h4>‚ö° Real-Time Scoring</h4>
                <p>Instant predictions at the point of sale for immediate action by staff.</p>
            </div>
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('purchaseForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(e.target);
    const data = {
        customer_age: parseInt(formData.get('customer_age')),
        customer_gender: formData.get('customer_gender'),
        hour: parseInt(formData.get('hour')),
        day_of_week: parseInt(formData.get('day_of_week')),
        temperature_c: parseFloat(formData.get('temperature_c')),
        is_rainy: formData.get('is_rainy') === 'true',
        visit_duration_minutes: parseInt(formData.get('visit_duration_minutes'))
    };

    document.getElementById('loading').style.display = 'block';
    document.getElementById('result').style.display = 'none';

    try {
        const response = await fetch('/api/predict/purchase', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        document.getElementById('loading').style.display = 'none';

        if (response.ok) {
            displayResult(result);
        } else {
            displayError(result.error || 'Prediction failed');
        }
    } catch (error) {
        document.getElementById('loading').style.display = 'none';
        displayError('Network error. Please try again.');
    }
});

function displayResult(result) {
    const tierColors = {
        'Low Value': 'var(--warning)',
        'Medium Value': 'var(--primary)',
        'High Value': 'var(--secondary)'
    };

    const resultDiv = document.getElementById('result');
    resultDiv.innerHTML = `
        <div class="result-card">
            <div class="result-header">
                <span style="font-size: 3rem;">üí∞</span>
                <h3>Purchase Prediction</h3>
            </div>

            <div class="result-grid">
                <div class="result-item" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <div class="result-label" style="color: rgba(255,255,255,0.8);">Predicted Value</div>
                    <div class="result-value" style="color: white;">$${result.predicted_value}</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Revenue Tier</div>
                    <div class="result-value" style="color: ${tierColors[result.revenue_tier]};">${result.revenue_tier}</div>
                </div>
            </div>

            <div class="result-item" style="margin-top: 1rem;">
                <div class="result-label">Confidence Interval (85%)</div>
                <div style="font-size: 1.25rem; font-weight: 600; color: var(--text);">
                    $${result.confidence_interval.lower} - $${result.confidence_interval.upper}
                </div>
            </div>

            <div class="result-description">
                <h4>üí° Upselling Recommendation</h4>
                <p><strong>${result.upselling_recommendation}</strong></p>
            </div>
        </div>
    `;
    resultDiv.style.display = 'block';
}

function displayError(message) {
    const resultDiv = document.getElementById('result');
    resultDiv.innerHTML = `
        <div class="result-card" style="border-left: 4px solid var(--danger);">
            <h3 style="color: var(--danger);">‚ùå Error</h3>
            <p>${message}</p>
        </div>
    `;
    resultDiv.style.display = 'block';
}
</script>
{% endblock %}
